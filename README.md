# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Архитекутрный подход: **MVP** (Model-View-Presenter)

1. Слой данных (**Model**) — данные, в которых отражена вся ценность приложения, содержит значительную часть бизнес-логики, при изменении данных, они попадают в отображение.

2. Слой отображения (**View**) — интерфейс для взаимодействия с пользователем, выводит на экран разметку с данными и генерирует события с действиями пользователя.

3. Слой управления (**Presenter**) слушает события в пользовательском интерфейсе и принимает решение, что с ними делать и в какую модель отнести, чтобы она среагировала и поменялась. Реализован черезEvent Broker, который позволяет компонентам системы взаимодействовать друг с другом через события, не имея прямой зависимости друг от друга, подписываться на события, инициировать их и управлять подписками.

## Описание данных

### Интерфейсы

- `IProduct` соответствует всем данным товара (id, описание, картинка, название, категория, цена, добавлен ли товар в корзину, индекс товара в корзине);
- Тип `CategoryType` представляет собой набор категорий товаров, используется для классификации товаров в приложении. 
- Тип `CategoryMapping` создает объект, где ключами являются значения из CategoryType, а значениями — строки. 
- `ICardsData` отвечает за хранение массива карточек, id выбранной карточки и работу с их данными.
- `IUserData` хранит данные пользователя и методы по установке, получению этих данных и валидации формы: тип `TUserOrder` используется на первом этапе оформления заказа и хранит информацию о способе оплаты и адрес доставки, `TUserContacts` используется на втором этапе оформления заказа, при вводе контактных данных (хранит электронную почту и номер телефона пользователя).
- `IBasket` будет использоваться при открытии корзины и содержать список товаров и их сумму, работу с отображением данных заказа.
- `ICatalog` хранит массив карточек, выводимых на главной странице, счетчик товаров в корзине, заблокирована ли страница для перемотки.
- `IOrder` типизирует заказ пользователя, содержит выбранный способ олаты, адрес, почту и телефон, массив выбранных товаров и их сумму.
-  Тип `FormErrors` представляет собой частичную запись, где ключами являются поля интерфейса IOrder, а значениями — строки, содержащие сообщения об ошибках валидации.
- `IModalData` описывает структуру данных, которые могут быть переданы в модальное окно, содержит одно свойство: элемент, который будет отображаться внутри модального окна.
- `IFormState` используется для общего класса отображения форм, содержит булево значение, отвечающее за валидность формы и список ошибок валидации.
- `ICardActions` определяет объект действий, который содержит метод `onClick`. Этот метод будет вызываться при клике на элемент карточки.
- Типы `ApiCardResponse` и `ApiOrderResponse` используются для типизации ответов сервера на запросы.
- `ISuccessActions` содержит событие клика мыши, которое содержит информацию о действии пользователя.
- `ISuccess` хранит сумму, которую пользователь должен оплатить за заказ.


### Базовый код (base)

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов. Методы:
- `get` выполняет GET запрос на переданный в параметрах endpoint и возвращает promise с объектом, которым ответил сервер;
- `post` принимает объект с данными, которые будут переданы в JSON в теле запроса и отправляет эти данные на endpoint, переданный как параметр при вызове метода. По умолчанию выполянет POST запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Реализует паттерн «Наблюдатель» и позволяет подписываться на события и уведомлять подписчиков
о наступлении события.\
Класс имеет методы `on`, `off`, `emit` — для подписки на событие, отписки от события и уведомления
подписчиков о наступлении события соответственно.\
Дополнительно реализованы методы  `onAll` и  `offAll`  — для подписки на все события и сброса всех
подписчиков.
Метод  `trigger` генерирует заданное событие с заданными аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. Эти классы будут генерировать события, не будучи при этом напрямую зависимыми от класса EventEmitter.

#### Класс Component
Абстрактный класс, который является родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. 
Прочие методы класса:
- `setDisabled`(element: HTMLElement, state: boolean): void - меняет статус блокировки элемента;
- `setText`(element: HTMLElement, value: string): void - устанавливает текстовое содержимое;
- `render`(data?: Partial<T>): HTMLElement - сохраняет полученные данные в поля компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Model
Класс-родитель всех компонентов моделей данных. Он принимает частичные данные типа T и объект событий IEvents в конструкторе. Класс предоставляет метод `emitChanges`, который позволяет эмитировать события с переданными данными.

### MODEL (СЛОЙ ДАННЫХ)

#### Класс CardsData
Отвечает за хранение и логику работы с данными карточек товаров на главной странице. 
В полях класса хранятся следующие данные:
- _cards: IProduct[] - массив объектов карточек продуктов, устанавливается при помощи сеттера;
- _preview: string | null - id карточки товара, выбранной для просмотра в модальном окне;

Методы для взаимодействия с данными:
- `setPreview`(card: IProduct): void - метод для установки поля _preview, хранящему id выбранного товара, запускает событие `preview:changed`;
- `toggleSelected`(card: IProduct): void - метод добавлят true/false в поле selected объекта карточки, вызывается при нажатии на кнопку "Купить" или клику по иконке удаления из корзины: событии `card:change`;
- `getCard`(cardId: string): IProduct | undefined - возвращает карточку по её id;
- `getAddedProducts`(): IProduct[] - фильтрует массив карточек по наличию `selected: true`;
- `getTotalPrice`(): number - получает сумму цены всех товаров в корзине;
- `resetSelected`(): void - сбрасывает значение поля selected после успешной покупки товаров.

#### Класс UserData
Класс UserData представляет собой модель, которая управляет данными пользователя, связанными с заказом. Он обеспечивает валидацию контактной информации и информации о заказе, а также хранит возможные ошибки валидации.\
В полях класса хранятся следующие данные:
- payment: string - выбранный способ оплаты товара;
- address: string - адрес доставки;
- email: string - адрес электронной почты;
- phone: string - номер телефона;

Также класс предоставляет набор методов для работы с этими данными:
- `setUserOrder`(field: keyof IOrder, value: string): void устанавливает значение для указанного поля заказа, вызывает валидацию контактов и информации о заказе (при успешной валидации генерируются события `contacts:ready` и `order:ready`);
- `getUserData`(): void возвращает объект с текущими данными пользователя, используемых при оформлении заказа;
- `validateOrder`(): void и `validateContacts`(): void - проверяет объект с данными пользователя на валидность, заполняет объект formErrors сообщениями об ошибках, если поля не заполнены, генерирует событие `orderFormErrors:change` или `contactsFormErrors:change`, если были изменения в ошибках. Возвращает true, если ошибок нет, и false в противном случае.


### VIEW (СЛОЙ ОТОБРАЖЕНИЯ), общие компоненты (common)

#### Класс Modal
 Наследует от базового класса `Component` и использует интерфейс `IModalData` для передачи данных.Реализует отображение всех модальных окон приложения, содержит методы `open` и `close` для управления поведением всех модальных окон, контент устанавливается с помощью сеттера. Устанавливает слушатели на клавиатуру для закрытия окна по клавише ESC, на клик по оверлею или кнопке закрытия(крестику).\

Поля хранят следующие данные:
- closeButton: HTMLButtonElement - кнопка закрытия модального окна;
- _content: HTMLElement - содержание, которое выводится в разметку модального окна, для его установки используется сеттер.
- events: IEvents - брокер событий.

Конструктор класса:
- constructor(container: HTMLElement, events: IEvents) принимает в качестве аргумента соответствующий контейнер модального окна и экземпляр класса 'EventEmitter' для возможности инициации событий.

Методы класса:
- `open`() открывает модальное окно, добавляя класс `modal_active` к контейнеру, вызывает событие `modal:open`, добавляет обработчик нажатия клавиши Escape.
- `close`() закрывает модальное окно, удаляя класс `modal_active`, вызывает событие `modal:close`, удаляет обработчик нажатия клавиши Escape.
- `handleEscUp`(evt: KeyboardEvent) обрабатывает нажатие клавиши Escape. Если модальное окно активно, вызывает метод `close()`.
- `render`(data: IModalData): HTMLElement рендерит модальное окно с переданными данными, вызывает метод `open()` для отображения окна, возвращает контейнер с модальным окном.

#### Класс Form
Предназначен для реализации формы, содержащей поля ввода, наследует от базового класса `Component` и использует интерфейс `IFormState` для управления состоянием формы. При отправке формы инициализирует событие, передавая в него объект с данными из полей ввода формы. Предоставляет методы для отображения ошибок и управления активностью кнопки сохранения. Поля класса:
- _submit: HTMLButtonElement - кнопка отправки формы;
- _errors: HTMLElement - элемент, в который выводятся ошибки валидации, для установки текста используется сеттер;

Конструктор класса:
- constructor (container: HTMLElement, events: IEvents) принимает в качестве аргумента соответствующий контейнер модального окна и экземпляр класса 'EventEmitter' для возможности инициации событий.

Методы класса:
- onInputChange(field: keyof T, value: string) обрабатывает изменения ввода в форме, вызывает событие `input:change` с именем поля и его значением.
- `render`(state: Partial<T> & IFormState) рендерит состояние формы, принимая частичное состояние с данными формы и состоянием валидации, обновляет свойства компонента на основе переданных данных, возвращает контейнер формы.


### VIEW (СЛОЙ ОТОБРАЖЕНИЯ)

#### Класс CardBasket
Представляет собой компонент отображения карточки товара в корзине. Он наследуется от базового класса `Component`, в конструктор класса передается контейнер карточки (container: HTMLElement) и `ICardActions` (опционально) — объект действий, содержащий обработчик события клика. Свойства следующие (для работы с ними используются сеттеры и геттеры):
- _index: HTMLElement — элемент, отображающий индекс товара в корзине.
- _button: HTMLButtonElement — кнопка для взаимодействия с карточкой.
- _title: HTMLElement — элемент заголовка карточки.
- _price: HTMLElement — элемент, отображающий цену товара.
- _id: string — уникальный идентификатор товара.

Метод `handlePrice`(value: number | null) обрабатывает и форматирует цену товара, возвращает строку с ценой или сообщение "Бесценно".

#### Класс CardCatalog
Класс `CardCatalog` расширяет функциональность класса `CardBasket`, добавляя поддержку категории и изображения товара.
- _category: HTMLElement — элемент, отображающий категорию товара.
- _image: HTMLImageElement — элемент изображения товара.

Сеттеры устанавливают источник изображения товара, категорию товара и добавляют соответствующий класс для стилей, устанавливают состояние кнопки (заблокирована или нет) в зависимости от того, добавлен ли товар в корзину.

#### Класс CardPreview
Класс `CardPreview` расширяет класс `CardCatalog`, добавляя поддержку описания товара. Единственное свойство: _description: HTMLElement — элемент, отображающий описание товара.

#### Класс Page
Представляет собой компонент страницы, который управляет отображением элементов каталога и корзины. Он наследуется от базового класса `Component` и принимает два параметра в конструкторе: контейнер типа HTMLElement и события типа IEvents.  Также в конструкторе добавляется обработчик события клика на кнопку корзины, который вызывает метод emit для открытия корзины. Поля заполняются при помощи сеттеров:
- _counter: HTMLElement - элемент, отвечающий за отображение количества товаров в корзине;
- _catalog: HTMLElement - элемент, представляющий галерею с товарами;
- _basket: HTMLButtonElement - кнопка, открывающая корзину;
- _wrapper: HTMLElement - обертка для содержимого страницы.

#### Класс Basket 
Отвечает за отображение товаров в корзине, для работы с полями класса используются сеттеры. Конструктор класса кроме родительского элемента (container: HTMLElement) принимает инстант брокера событий (вызывается при нажатии на кнопку и запуске события `order:open`). Поля класса (для установки значений используются сеттеры):\
- _list: HTMLElement - элемент, представляющий список товаров;
- _total: HTMLElement - элемент, отображающий общую стоимость;
- _button: HTMLButtonElement - кнопка для оформления заказа.

#### Класс Order
Описывает окно оформления заказа, позволяя пользователю выбирать способ оплаты (картой или наличными) и вводить адрес доставки. Он наследует функциональность от базового класса Form, поля класса содержат ссылки на кнопки выбора оплаты заказа и адрес пользователя:
- _card: HTMLButtonElement;
- _cash: HTMLButtonElement;
- _address: HTMLInputElement;

Конструктор принимает родительский элемент `container: HTMLFormElement` и обработчик событий events: IEvents, в классе устанавливаются соответствующие слушатели событий на нажатие кнопок.

#### Класс Contacts
Описывает окно контактов, управляет формой ввода контактной информации пользователя, включая адрес электронной почты и номер телефона. Наследует функциональность от базового класса Form. Конструктор принимает родительский элемент и обработчик событий (container: HTMLFormElement, events: IEvents);

#### Класс Success
отображает сообщение об успешном завершении заказа и общую сумму, которую пользователь оплатил. Он наследует функциональность от базового класса Component. Конструктор принимает родительский элемент и actions - объект, содержащий действия для обработки событий, таких как клик по кнопке закрытия. (container: HTMLFormElement, actions: ISuccessActions).


### СЛОЙ КОММУНИКАЦИИ

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы, реализующие взаимодействие с бэкендом сервиса.

### Взаимодействие компонентов:
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера. Взаимодействие осуществляется за счет событий, генерируемых с помощью брокера событий и обработчиков этих событий, настраиваемых в `index.ts` после создания экземпляров всех необходимых классов.

***Список всех событий, которые могут генерироваться в системе:***\
*События изменения данных (генерируются классами моделей данных):*
- `cards:loaded` - массив карточек при загрузке страницы изменен;
- `preview:changed` - карточка выбрана для открытия её в модальном окне;
- `basket:changed` - перерисовка корзины при добавлении товара в корзину / его удалении;

*События, возникающие при взаимодействии с пользователем (генерируются классами слоя представления):*
- `preview:change` - открытие карточки товара;
- `card:change` - добавление товара в корзину / удаление товара из корзины;
- `basket:open` - открытие корзины с товарами;
- `order:open` - открытие окна ввода данных пользователя на первом этапе оформления заказа;
- `input:change` - изменение данных в любом поле ввода данных;
- `order:submit` - отправка данных пользователя на первом этапе оформления заказа и открытие окна ввода контактов;
- `orderFormErrors:change` - изменение состояния валидации заказа;
- `contactsFormErrors:change` - изменение состояния валидации контактов;
- `contacts:submit` - отправка данных пользователя на втором этапе оформления заказа и открытие окна успеха;
- `order:success` - обработка успеха оформления заказа;
- `modal:open` - открытие модального окна;
- `modal:close` - закрытие модального окна.